---
- name: Load variables
  include_vars: "{{ item }}"
  with_first_found:
    - "radicale.yml"
  tags:
    - always

- name: Setup Radicale configuration
  block:
    - name: Create data folder
      file:
        path: "{{ radicale_config.data }}"
        state: directory
    - name: Copy config folder
      copy:
        src: files/config/
        dest: "{{ radicale_config.config }}"
        backup: yes
        owner: root
        group: root
    - name: Create log folder
      file:
        path: "{{ radicale_config.log }}"
        state: directory

- name: Create Radicale image
  docker_image:
    name: "{{ radicale_image_name }}"
    build:
      path: "{{ radicale_repository }}"
      dockerfile: "{{ radicale_dockerfile }}"
    source: build

- name: Create Radicale container
  vars:
    recreate_radicale_container: no
  include: create-container.yml

- name: Recreate Radicale container
  vars:
    recreate_radicale_container: yes
  include: create-container.yml
  tags:
    - never
    - recreate
